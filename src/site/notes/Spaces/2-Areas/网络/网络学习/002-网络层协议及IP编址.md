---
{"dg-publish":true,"dg-path":"网络/网络学习/002-网络层协议及IP编址.md","permalink":"/网络/网络学习/002-网络层协议及IP编址/"}
---

# 一、网络层协议
网络层经常被称为IP层。但网络层协议并不只是IP协议，还包括ICMP（Internet Control Message Protocol)协议、IPX（Internet Packet Exchange）协议等。

IP是Internet Protocol的缩写。 Internet Protocol本身是一个协议文件的名称，该协议文件的内容非常少，主要是定义并阐述了IP报文的格式。
经常被提及的IP，一般不是特指Internet Protocol这个协议文件本身，而是泛指直接或间接与IP协议相关的任何内容。

IP协议有版本之分，分别是IPv4和IPv6。目前，Internet上的IP报文主要都是IPv4报文，但是逐步在向IPv6过渡。若无特别声明，本章所提及的IP均指IPv4。
- IPv4（Internet Protocol Version 4）协议族是TCP/IP协议族中最为核心的协议族。它工作在TCP/IP协议栈的网络层，该层与OSI参考模型的网络层相对应。
- IPv6（Internet Protocol Version 6）是网络层协议的第二代标准协议，也被称为IPng（IP Next Generation）。它是Internet工程任务组IETF（Internet Engineering Task Force）设计的一套规范，是IPv4（Internet Protocol Version 4）的升级版本。
## 1.IPv4报文格式
![../../../../Extras/Media/media-002-网络层协议及IP编址-1.png](/img/user/Extras/Media/media-002-%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8F%8AIP%E7%BC%96%E5%9D%80-1.png)

**IP Packet（IP数据包），其包头主要内容如下：**
- Version：4 bit，4：表示为IPv4；6：表示为IPv6。
- Header Length：4 bit，首部长度，如果不带Option字段，则为20，最长为60。
- Type of Service：8 bit，服务类型。只有在有QoS差分服务要求时，这个字段才起作用。 
- Total Length：16 bit，总长度，整个IP数据包的长度。 
- Identification：16 bit，标识，分片重组时会用到该字段。 
- Flags：3 bit，标志位。
- Fragment Offset：12 bit，片偏移，分片重组时会用到该字段。
- Time to Live：8 bit，生存时间。
- Protocol：8 bit，协议：下一层协议。指出此数据包携带的数据使用何种协议，以便目的主机的IP层将数据部分上交给哪个进程处理。
	- 常见值：
		- 1: ICMP, Internet Control Message；
		- 2: IGMP, Internet Group Management；
		- 6: TCP , Transmission Control Protocol；
		- 17: UDP, User Datagram Protocol。
- Header Checksum：16 bit，首部检验和。
- Source IP Address：32 bit，源IP地址。 
- Destination IP Address：32 bit，目的IP地址。 
- Options：可变，选项字段。 
- Padding：可变，填充字段，全填0。 
## 2.数据包分片
将报文分割成多个片段的过程叫做分片。
网络中转发的IP报文的长度可以不同，但如果报文长度超过了数据链路所支持的最大长度，则报文就需要分割成若干个较小的片段才能够在链路上传输。

![../../../../Extras/Media/media-002-网络层协议及IP编址-2.png](/img/user/Extras/Media/media-002-%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8F%8AIP%E7%BC%96%E5%9D%80-2.png)
- Identification：16 bit，发送主机赋予的标识，分片重组时会用到该字段。
- Flags：3 bit，标志位。
	- 保留段位：0，保留。
	- 不分段位：1，表示“不能分片”；0，表示“能分片”。
	- 更多段位：1，表示“后面还有分片”；0，表示“最后一个数据片”。
- Fragment Offset：12 bit，片偏移，分片重组时会用到该字段。指出较长的分组在分片后，该片在原分组中的相对位置，与更多段位组合，帮助接收方组合分段的报文。
## 3.生存时间 （Time to Live, TTL）
Time to Live：8 bit，生存时间。可经过的最多路由数，即数据包在网络中可通过的路由器数的最大值。
TTL字段设置了数据包可以经过的路由器数目。
报文在网段间转发时，如果网络设备上的路由规划不合理，就可能会出现环路，导致报文在网络中无限循环，无法到达目的端。环路发生后，所有发往这个目的地的报文都会被循环转发，随着这种报文逐渐增多，网络将会发生拥塞。
为避免环路导致的网络拥塞，IP报文头中包含一个生存时间TTL（Time To Live）字段。报文每经过一台三层设备，TTL值减1。初始TTL值由源端设备设置。当报文中的TTL降为0时，报文会被丢弃。同时，丢弃报文的设备会根据报文头中的源IP地址向源端发送ICMP错误消息。（注意：网络设备也可被配置为不向源端发送ICMP错误消息。）
## 4.协议号 (Protocol)
IP报文头中的协议号字段标识了将会继续处理该报文的协议。
即指出此数据包携带的数据使用何种协议，以便目的主机的IP层将数据部分上报给哪个进程处理。
# 二、IPv4地址介绍
IP地址在网络中用于标识一个节点（或者网络设备的接口），用于IP报文在网络中的寻址。
IP地址是网络设备接口的属性，不是网络设备本身的属性。当我们说给某台设备分配一个IP地址时，实质上是指给这台设备的某个接口分配一个IP地址。如果设备有多个接口，通常每个接口都至少需要一个IP地址。
**注**：需要使用IP地址的接口，通常是路由器和计算机的接口。
## 1.二进制与十进制换算
![../../../../Extras/Media/media-002-网络层协议及IP编址-3.png](/img/user/Extras/Media/media-002-%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8F%8AIP%E7%BC%96%E5%9D%80-3.png)
## 2.IP地址构成
IP地址是长度是32 bit，由4个字节组成，通常采用点分十进制数来表示。
- 网络部分：用来标识一个网络。
- 主机部分：用来区分一个网络内的不同主机。
- 网络掩码：区分一个IP地址中的网络部分及主机部分。

![../../../../Extras/Media/media-002-网络层协议及IP编址-4.png](/img/user/Extras/Media/media-002-%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8F%8AIP%E7%BC%96%E5%9D%80-4.png)

网络掩码 (Netmask)，又称子网掩码 (Subnet Mask):
- 网络掩码为32 bit，与IP地址的位数一样，通常也以点分十进制数来表示。
- 网络掩码不是一个IP地址，在二进制的表示上是一堆连续的1、后面接一堆连续的0。
- 通常将网络掩码中1的个数称为这个网络掩码的长度。如：掩码0.0.0.0的长度是0，掩码252.0.0.0的长度是6。
- 网络掩码一般与IP地址结合使用，其中值为1的比特对应IP地址中的网络位；值为0的比特对应IP地址中的主机位，以此来辅助我们识别一个IP地址中的网络位与主机位。即网络掩码中1的个数就是IP地址的网络号的位数，0的个数就是IP地址的主机号的位数。

**举例：**

|IP地址|192.168.100.100|
|:-:|:-:|
|子网掩码|255.255.255.0|
|则网络地址为|192.168.100.0|

## 3.IP地址寻址
- 网络部分：用来标识一个网络，代表IP地址所属网络。
- 主机部分：用来区分一个网络内的不同主机，能唯一标识网段上的某台设备。

网关：
- 报文转发过程中，首先需要确定转发路径以及通往目的网段的接口。如果目的主机与源主机不在同一网段，报文需要先转发到网关，然后通过网关将报文转发到目的网段。
- 网关是指接收并处理本地网段主机发送的报文并转发到目的网段的设备。为实现此功能，网关必须知道目的网段的IP地址。网关设备上连接本地网段的接口地址即为该网段的网关地址。
## 4.IP地址分类（有类编址） 
![../../../../Extras/Media/media-002-网络层协议及IP编址-5.png](/img/user/Extras/Media/media-002-%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8F%8AIP%E7%BC%96%E5%9D%80-5.png)

|地址类型|引导位|W的范围|地址结构|可用网络地址数|可用主机地址数|
|:-:|:-:|:-:|:-:|:-:|:-:|
|A类|0|1-126|网.主.主.主|126(27-1)|16777214(224-2)|
|B类|10|128-191|网.网.主.主|16384(214)|65534(216-2)|
|C类|110|192-223|网.网.网.主|2097152(221)|254(28-2)|
|D类|1110|224-239||组播地址||
|E类|1111|240-||研究和实验用地址||

## 5.IP地址的分配原则
1. 只有A、B、C三类地址可以分配给计算机和网络设备
2. 网络地址的第一个数字不能为127，保留用来测试连接
3. 网络地址不能全为0，也不能全为255：全为0没有网络，全为255用作子网掩码
4. 主机地址中不能全为0，也不能全为1：主机地址全为0用来表示网络地址，全为1用作广播
5. 网络地址相同主机地址必须唯一
6. 不能使用的IP：0.0.0.0、255.255.255.255、127.x.x.x、A.0.0.0、A.255.255.255、B.B.0.0、B.B.255.255、C.C.C.0、C.C.C.255

- 网络地址
	- 网络号为X，主机号的每个比特都为0。
	- 不能分配给具体的主机接口使用。
- 广播地址
	- 网络号为X，主机号的每个比特都为1。
	- 不能分配给具体的主机接口使用。
- 可用地址
	- 又称主机地址，可用分配给具体的主机接口使用。
- 一个网段可用地址数量计算：
	- 一个网段的主机位为n位，则IP地址数为：2ⁿ，可用IP地址数为：2ⁿ-2 (减去网络地址和广播地址)。
## 6.一些特殊的IP地址
1. IP地址127.0.0.1：本地回环(loopback)测试地址，测试设备自身的软件系统
2. 广播地址：255.255.255.255
3. IP地址0.0.0.0：代表任何网络
4. 网络号全为0：代表本网络或本网段
5. 网络号全为1：代表所有的网络
6. 本地链路地址169.254.0.0/24：当主机自动获取地址失败后，可使用该网段中的某个地址进行临时通信
## 7.私有地址（Private address）
为了解决IP地址短缺的问题，提出了私有地址的概念。私有地址是指内部网络或主机地址，这些地址只能用于某个内部网络，不能用于公共网络。
- **公网IP地址**：IP地址是由IANA统一分配的，以保证任何一个IP地址在Internet上的唯一性。这里的IP地址是指公网IP地址。
- **私网IP地址**：私网IP地址的使用使得网络可以得到更为自由地扩展，因为同一个私网IP地址是可以在不同的私有网络中重复使用的。

私有IP（供企业内部使用）：
- A类：10.0.0.0~10.255.255.255
- B类：172.10.0.0~172.31.255.255
- C类：192.168.0.0~192.168.255.255

注：
- NAT (Network Address Translation)，网络地址转换，其基本作用是实现私网IP地址与公网IP地址之间的转换。
- IANA (Internet Assigned Numbers Authority)，因特网地址分配组织。
## 8.IPv4 vs IPv6
由全球IP地址分配机构，IANA (Internet Assigned Numbers Authority)管理的IPv4地址，于2011年完全用尽。随着最后一个IPv4公网地址分配完毕，加上接入公网的用户及设备越来越多，IPv4地址枯竭的问题日益严重，这是当前IPv6替代IPv4的最大源动力。
## 9.IP组播地址
![../../../../Extras/Media/media-002-网络层协议及IP编址-6.png](/img/user/Extras/Media/media-002-%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8F%8AIP%E7%BC%96%E5%9D%80-6.png)

IP组播地址：224.0.0.0－239.255.255.255

知名的组播地址：
- 224.0.0.1－所有主机
- 224.0.0.2－所有路由器
# 三、子网划分
## 1.可变长子网掩码VLSM (Variable Length Subnet Mask)
“有类编址”的地址划分过于死板，划分的颗粒度太大，会有大量的主机号不能被充分利用，从而造成了大量的IP地址资源浪费。
因此可以利用子网划分来减少地址浪费，即VLSM (Variable Length Subnet Mask)，可变长子网掩码。将一个大的有类网络，划分成若干个小的子网，使得IP地址的使用更为科学。

1. 子网划分是通过借位实现的，从主机位借位表示子网位
2. 最少要借1位，最多借位要保证主机位剩余2位
3. 若借n位表示子网，则子网数是2的n次方个,若每一个子网主机
位是m位，则该子网可用主机数是2的m次方减去2个
4. 子网划分是通过增加掩码长度实现的

子网掩码：是用来对IP地址进行解释的，也是由32位2进制表示的，1对于网络位或子网位，0对应主机位
前缀：是子网掩码的另外一种表示，子网掩码1的个数/N

**举例：**
172.16.7.170/26
该主机所在子网的网络地址：172.16.7.128
该主机所在子网广播地址：172.16.7.191
该主机所在子网第一个可用ip：172.16.7.129
该主机所在子网最后一个可用ip：172.16.7.190
## 2.无类别域间路由CIDR（Classless Inter-Domain Routing）
用于帮助减缓IP地址耗尽和路由表增大的问题，多个C类地址块可以被组合或聚合在一起以生成更大的无类别IP地址集，也就是说，我们可以用一个CIDR的聚合体来表示一组C类地址。
# 四、ICMP协议
Internet控制消息协议ICMP (Internet Control Message Protocol)是IP协议的辅助协议。
ICMP协议用来在网络设备间传递各种差错和控制信息，对于收集各种网络信息、诊断和排除各种网络故障等方面起着至关重要的作用。
![../../../../Extras/Media/media-002-网络层协议及IP编址-7.png](/img/user/Extras/Media/media-002-%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8F%8AIP%E7%BC%96%E5%9D%80-7.png)

|Type|Code|描述|
|:-:|:-:|:-:|
|0|0|Echo Reply|
|3|0|网络不可达|
|3|1|主机不可达|
|3|2|协议不可达|
|3|3|端口不可达|
|5|0|重定向|
|8|0|Echo Request|

- ICMP消息封装在IP报文中，IP报文头部Protocol值为1时表示ICMP协议。
- 字段解释：
	- ICMP消息的格式取决于Type和Code字段，其中Type字段为消息类型，Code字段包含该消息类型的具体参数。
	- 校验和字段用于检查消息是否完整。
	- 消息中包含32 bit的可变参数，这个字段一般不使用，通常设置为0。
		- 在ICMP重定向消息中，这个字段用来指定网关IP地址，主机根据这个地址将报文重定向到指定网关。
		- 在Echo请求消息中，这个字段包含标识符和序号，源端根据这两个参数将收到的回复消息与本端发送的Echo请求消息进行关联。尤其是当源端向目的端发送了多个Echo请求消息时，需要根据标识符和序号将Echo请求和回复消息进行一一对应。
## 1.ICMP重定向
ICMP重定向报文是ICMP控制报文中的一种。在特定的情况下，当路由器检测到一台机器使用非最优路由的时候，它会向该主机发送一个ICMP重定向报文，请求主机改变路由。
![../../../../Extras/Media/media-002-网络层协议及IP编址-8.png](/img/user/Extras/Media/media-002-%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8F%8AIP%E7%BC%96%E5%9D%80-8.png)
ICMP重定向过程：
1. 主机A希望发送报文到服务器A，于是根据配置的默认网关地址向网关RTB发送报文。
2. 网关RTB收到报文后，检查报文信息，发现报文应该转发到与源主机在同一网段的另一个网关设备RTA，此转发路径是更优的路径，所以RTB会向主机发送一个Redirect消息，通知主机直接向另一个网关RTA发送该报文。
3. 主机收到Redirect消息后，会向RTA发送报文，然后RTA会将该报文再转发给服务器A。
## 2.ICMP差错检测
ICMP Echo消息常用于诊断源和目的地之间的网络连通性，同时还可以提供其他信息，如报文往返时间等。
ICMP的一个典型应用是Ping。Ping是检测网络连通性的常用工具，同时也能够收集其他相关信息。用户可以在Ping命令中指定不同参数，如ICMP报文长度、发送的ICMP报文个数、等待回复响应的超时时间等，设备根据配置的参数来构造并发送ICMP报文，进行Ping测试。

**功能：Ping**
Ping是网络设备、Windows、Unix和Linux平台上的一个命令，其实是一个小巧而实用的应用程序，该应用基于ICMP协议。
Ping常用于探测到达目的节点的网络可达性。
```
[RTA]ping 20.0.0.2
PING 20.0.0.2: 56  data bytes, press CTRL_C to break
Reply from 20.0.0.2: bytes=56 Sequence=1 ttl=254 time=70 ms
Reply from 20.0.0.2: bytes=56 Sequence=2 ttl=254 time=30 ms
Reply from 20.0.0.2: bytes=56 Sequence=3 ttl=254 time=30 ms
Reply from 20.0.0.2: bytes=56 Sequence=4 ttl=254 time=40 ms
Reply from 20.0.0.2: bytes=56 Sequence=5 ttl=254 time=30 ms

--- 20.0.0.2 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 30/40/70 ms
```
## 3.ICMP错误报告
- ICMP定义了各种错误消息，用于诊断网络连接性问题；根据这些错误消息，源设备可以判断出数据传输失败的原因。
	- 如果网络中发生了环路，导致报文在网络中循环，且最终TTL超时，这种情况下网络设备会发送TTL超时消息给发送端设备。
	- 如果目的地不可达，则中间的网络设备会发送目的不可达消息给发送端设备。目的不可达的情况有多种，如果是网络设备无法找到目的网络，则发送目的网络不可达消息；如果网络设备无法找到目的网络中的目的主机，则发送目的主机不可达消息。

ICMP的另一个典型应用是Tracert。Tracert基于报文头中的TTL值来逐跳跟踪报文的转发路径。为了跟踪到达某特定目的地址的路径，源端首先将报文的TTL值设置为1。该报文到达第一个节点后，TTL超时，于是该节点向源端发送TTL超时消息，消息中携带时间戳。然后源端将报文的TTL值设置为2，报文到达第二个节点后超时，该节点同样返回TTL超时消息，以此类推，直到报文到达目的地。这样，源端根据返回的报文中的信息可以跟踪到报文经过的每一个节点，并根据时间戳信息计算往返时间。

**功能：Tracert**
Tracert基于报文头中的TTL值来逐跳跟踪报文的转发路径。Tracert是检测网络丢包和时延的有效手段，同时可以帮助管理员发现网络中的路由环路。
```
[RTA]tracert 20.0.0.2

traceroute to  20.0.0.2(20.0.0.2), max hops: 30 ,packet length: 40,press CTRL_C
to break 

1 10.0.0.2 		80 ms  	10 ms  	10 ms 

2 20.0.0.2 		30 ms  	30 ms  	20 ms 
```
# 五、IPv4地址配置及基本应用
## 1.IPv4地址配置
1. 进入接口视图

<font class="code">[Huawei] **interface** *interface-type interface-number*</font>

通过此命令可以进入指定的接口视图，配置接口的相关属性。
- *interface-type interface-number*：指定接口类型和接口编号。接口类型和接口编号之间可以输入空格也可以不输入空格

2. 配置接口的IP地址

<font class="code">[Huawei-GigabitEthernet0/0/1] **ip address** *ip-address* { *mask* | *mask-length* }</font>

在接口视图下，通过此命令来给网络设备上的接口配置IP地址，实现网络的互连。
- *ip-address*：指定接口的IP地址，点分十进制形式。
- *mask*：指定子网掩码，点分十进制形式。
- *mask-length*：指定掩码长度，整数形式，取值范围是0～32，在思科中，无法使用掩码长度，只能使用点分十进制形式的指定子网掩码。

## 2.案例：配置接口IP地址
**配置物理接口地址：**

<font class="code">[RTA] **interface** gigabitethernet 0/0/1
[RTA-GigabitEthernet0/0/1] **ip address** 192.168.1.1 255.255.255.0
或
[RTA-GigabitEthernet0/0/1] **ip address** 192.168.1.1 24</font>

**配置逻辑接口地址：**

<font class="code">[RTA] **interface** LoopBack 0
[RTA-LoopBack0] **ip address** 1.1.1.1 255.255.255.255
或
[RTA-LoopBack0] **ip address** 1.1.1.1 32</font>

- 物理接口：物理接口是指网络设备上实际存在的接口，分为负责承担业务传输的业务接口和负责管理设备的管理接口，例如GE业务接口和MEth管理接口。
- 逻辑接口：逻辑接口是指能够实现数据交换功能但物理上不存在、需要通过配置建立的接口，需要承担业务传输，例如VLANIF接口、Loopback接口。
	- Loopback环回接口：是逻辑接口，可以通过环回接口指定多个ip地址段，从而可以在一个设备上面添加多个网段。它的稳定性非常高，只与系统相关，不与物理接口相关。

***
# 参考文献
[1] 华为技术有限公司.网络层协议及IP编址[PPT].(2020)[2025-09-12]
[2] 国家网络技术水平考试.第1章 IP 子网划分和变长子网掩码[PPT].[2025-09-12]